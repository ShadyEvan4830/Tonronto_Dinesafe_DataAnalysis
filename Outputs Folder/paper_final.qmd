---
title: "Analyzing Toronto's Dining Scene: Public Food Safety and Economic Indicators in Focus"
subtitle: "A public health environment that is constantly improving"
author: 
  - Tianen (Evan) Hao
thanks: "Code and data are available at: https://github.com/ShadyEvan4830/Tonronto_Dinesafe_DataAnalysis.git"
date: January 21, 2024
date-format: long
abstract: "This report uses the R programming language to analyze a data set of food safety inspections at Toronto dining establishments and further uses additional data sets to correlate food safety trends with an economic indicator such as the Consumer Price Index (CPI). Our analysis shows a limited reduction in sanitation infractions; this potentially means food safety compliance is improving in the City of Toronto. Additionally, the analysis suggests some potential links between economic downturns and increases in health infractions. This report is an appropriate reference resource for policymakers, and it overall highlights the inextricable relationship between economic health and public safety."
format: pdf
toc: true
number-sections: true
bibliography: bibliography.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(palmerpenguins)
```


# Introduction

Toronto’s vibrant dining scene is a cornerstone of the city’s culture and economy, which is why residents and visitors need strict health screenings to ensure food safety standards. Yet the public often overlooks the fact that dining establishments must adhere to strict health standards.

Over the years, public health and safety in the food service industry have received increasing attention since foodborne illness can have serious and sometimes fatal consequences. Each year, Toronto Public Health monitors, inspectcs and reports on health and safety standards at food establishments across the city; this data is fully publicly available to allow the public to have a complete understanding of the current situation. Nonetheless, among the existing studies, there are few professional analysis of Toronto restaurant food safety data, or a lack of research that directly correlates economic factors with food safety standards.

This report conducts in-depth analysis of Dinesafe data provided by the City of Toronto's open data website OpenDataToronto [@opendatatoronto]. We use the programming language R [@citeR] to display trends in the data, focusing on key indicators such as inspection pass rate and changes in infraction details. In addition, this report extends further to examine how economic changes indicated by external factors such as the Consumer Price Index (CPI) are related to changes in public health standards within the food industry. Through analysis, we found that restaurants are more likely to violate food safety regulations, and there is a correlation between CPI fluctuations and infraction behaviours. That is, when CPI decreases, the number of infraction behaviours will increase.

Based on the above research, we aim to provide the public with further nuanced insights, inform policy decisions, and ultimately contribute to the ongoing conversation about public health and safety in urban food landscapes. 



# Dataset Explanation
In this report, we used the programming language R [@citeR] and library packages include `AER`[@AER], `future`[@future], `gircreds`[@gitcreds], `knitr`[@knitr], `lintr`[@lintr], `renv`[@renv], `reprex`[@reprex], `styler`[@styler], `tictoc`[@tictoc], `tidyverse`[@tidyverse], `tinytex`[@tinytex], and `usethis`[@usethis] to conduct in-depth analysis from multiple aspects. Prior to analysis, we resolved missing data and extracted relevant temporal components for annual trend analysis.

## Dinesafe
The Dinesafe dataset is publicly available from the City of Toronto [@opendatatoronto] and covers several years from 2022 to 2024, with key variables such as establishment type, inspection dates, and infraction details regarding the health status of public restaurants shown in @tbl-Sample_of_DineSafe_Data.


```{r}
#| echo: false
#| label: tbl-Sample_of_DineSafe_Data
#| tbl-cap: Sample of DineSafe Data
#| message: false
#| warning: false
library(readr)
library(dplyr)
library(knitr)
library(kableExtra)

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv")

sample_dataset <- dataset %>%
  select(`Establishment Status`, `Min. Inspections Per Year`, Severity) %>%
  head()

kable(sample_dataset, 
      col.names = c("Establishment Status", "Minimum Inspections Per Year", "Severity")) %>%
  kable_styling(full_width = FALSE, position = "center")

```

## Toronto's Dashboard Key Indicators
In addition, this report hopes to find the connection between public health trends and society from a broader perspective. To this end, we further searched for the dataset of Toronto's Dashboard Key Indicators through @opendatatoronto. This dataset contains many economic-related indicators that the Toronto government is open to the public; we extracted the relevant time period of the Consumer Price Index (CPI) that is consistent with dinesafe for analysis. 

# Data Analysis Result

## Toronto Dine Safe Pass Status
We extracted the complete data through R and classified the number of institutions by Establishment Status in Dinesafe dataset [@TorontoDineSafe2021], specifically showing two categories: "Conditional Pass" and "Pass" as @fig-Number_of_Establishments_by_Status shown. Taken together the count for the immediate "Pass" category is significantly higher, indicated by the higher bar on the right, indicating that more businesses are fully compliant with health inspection standards than those receiving a "Conditional Pass". "Conditional pass" indicates that a certain number of businesses must address certain issues to fully comply with health standards. This visual demonstrates that the majority of businesses inspected are adhering to the required health and safety guidelines.

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-Number_of_Establishments_by_Status
#| fig-cap: Number of Establishments by Status
library(tidyverse)

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv")

status_count <- dataset %>%
  group_by(`Establishment Status`) %>%
  summarize(Count = n())

ggplot(status_count, aes(x = `Establishment Status`, y = Count)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(
       x = "Establishment Status", y = "Count")
```
\break
## Infraction Data
In addition to the companies that passed above, the DineSafe data set also shows many companies whose food safety inspections were judged to be infraction. We conduct statistical analysis on the extent of these Total Infractions companies [@tbl-total_count_severity_levels]. The results show that most of the businesses that have the amount of 28030 with violations are at the "Minor" level; this means that their violations of the hygiene assessment are minor and can be improved and reach the passing standard in a relatively faster time, which is a positive representation of Infractions The overall trend can improve faster. Despite this, data shows that 14379 companies still face a "Significant" level of sanitation infractions; this means that they may need to spend more time and cost to improve sanitation conditions to provide better protection to the public.

\break
```{r}
#| echo: false
#| message: false
#| warning: false
#| label: tbl-total_count_severity_levels
#| tbl-cap: Total Count of different Severity levels
library(readr)
library(dplyr)
library(knitr)
library(kableExtra)

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv")

dataset <- dataset %>%
  mutate(Severity = str_remove_all(Severity, "^NA - |^[A-Z]+ - "))

severity_counts <- dataset %>%
  filter(Severity != "" & !is.na(Severity)) %>%
  count(Severity, name = "Total_Count")

kable(severity_counts, 
      col.names = c("Severity", "Total Count")) %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover"))

```


## Infraction Type Assessment
Since there are too many types of companies, we selected the three most numerous categories for bar chart comparison [@fig-distribution_by_severity]. They are Supermarket, Restaurant, and Food Take Out. Each category is divided into four violation severity levels: Minor, Significance, Crucial and Not Applicable (NA) further divided.

According to the analysis, we found that the category level of Minor has the highest number of infractions among all types of places, and the frequency of infractions in restaurants is particularly high. This suggests that while minor infractional behaviors are common, they are usually not serious and can be corrected with minimal intervention.

Compared to minor infractions, the number of infractions belonging to NA is relatively small. This category represents situations where standard infraction categories do not apply, perhaps due to specific exemptions or non-standard operations within the enterprise.

Significantly fewer infractions were labeled major than minor ones, which may indicate that more serious health risks are less likely to occur. Nonetheless, the presence of these infractions indicates the need for improvements to ensure public health.

The last infraction labeled Crucial is the least common, indicating relatively few cases that pose an immediate and serious health risk. However, their presence, especially in restaurants and supermarkets, highlights the importance of strict and regular inspections to prevent such significant risks to public health.

```{r}
#| echo: false
#| message: false
#| warning: false
#| label: fig-distribution_by_severity
#| fig-cap: Distribution of Food Inspection Infractions by Severity
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(readr)  # readr is used for read_csv

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv")

selected_severity_levels <- c("C - Crucial", "M - Minor", "NA - Not Applicable", "S - Significant")
top_types <- dataset %>%
  count(`Establishment Type`) %>%
  top_n(3, n) %>%
  pull(`Establishment Type`)

dataset_filtered <- dataset %>%
  filter(Severity %in% selected_severity_levels, `Establishment Type` %in% top_types)

ggplot(dataset_filtered, aes(x = `Establishment Type`, fill = Severity)) +
  geom_bar(alpha = 0.8, position = position_dodge(width = 0.75)) +
  theme_minimal() +
  facet_wrap(~Severity, ncol = 1, scales = "free_y") +
  coord_flip() +
  labs(x = "Establishment Type", y = "Count of Infractions")

```
\break
## Actions from Infraction Companies
To further evaluate the actions taken by these violating companies after being flagged, we used the “Minor” level with the most violations for analysis and created a pie chart to more clearly visualize the data [@fig-distribution_minor_severity_infractions]. The chart is dominated by the blue proportion, which represents the behaviour of "notice to comply." This suggests that in most cases of minor level, immediate closure or fines are not the first action consider by Toronto Public Health; instead, businesses are given the opportunity to make amends within a certain period.


```{r}
#| echo: false
#| message: false
#| label: fig-distribution_minor_severity_infractions
#| fig-cap: Distribution of Food Inspection Infractions by Severity
#| warning: false
library(ggplot2)
library(dplyr)
library(opendatatoronto)
library(lubridate)

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv")

minor_severity_actions <- dataset %>%
  filter(Severity == "M - Minor") %>%
  count(Action) %>%
  arrange(desc(n))

ggplot(minor_severity_actions, aes(x = "", y = n, fill = Action)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar(theta = "y") + # This creates a pie chart, remove this line for a stacked bar chart
  theme_minimal() +
  labs(
       x = "Action", y = "Count")

```
\break
## Potential Relationship between CPI and Number of Infractions
CPI is an economic indicator that measures changes in the inflation rate or cost of living in a country or region [@goldberg2010sensitivity]. In the early days of writing this report, the AI language model ChatGPT 4 [@openai2023chatgpt4] provided the author with inspiration for relevant economic indicators; the author finally selected CPI as a suitable indicator. The relevant data for this CPI comes from Toronto's Dashboard Key Indicators data set published by the City of Toronto @opendatatoronto. We generated two line charts [@fig-trend_comparison_of_cpi_and_infractions], showing the CPI trend and the infraction number trend respectively. Observation shows that when CPI decreases, corporate hygiene violations will increase. Although there may not be a direct causal relationship between the two, their trends may be affected by similar external factors. For example, a decline in CPI is usually a sign of a recession, which indicates that Toronto residents will potentially have more difficulties financially; therefore, businesses will spend less money on maintaining food safety conditions in order to stabilize the economic situation.

```{r}
#| echo: false
#| message: false
#| eval: true
#| label: fig-trend_comparison_of_cpi_and_infractions
#| fig-cap: "Trend comparison of CPI and Infractions"
#| fig-subcap: ["CPI Trend","Infractions Trend"]
#| layout-ncol: 2
#| warning: false
library(ggplot2)
library(dplyr)
library(readr)

cpi_data <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal2.csv") %>%
  filter(measure_name == "CPI - Consumer Price Index - Toronto (% Change)") %>%
  rename(CPI = measure_value) %>%
  mutate(Year = as.numeric(year)) %>%
  group_by(Year) %>%
  summarize(Average_CPI = mean(CPI, na.rm = TRUE))

dataset <- read_csv("/cloud/project/Inputs Folder/Data/AnalysisDataFinal1.csv") %>%
  mutate(Inspection_Date = as.Date(`Inspection Date`, format = "%Y-%m-%d")) %>%
  mutate(Year = as.numeric(format(Inspection_Date, "%Y"))) %>%
  group_by(Year) %>%
  summarize(Total_Infractions = n())

common_years <- intersect(cpi_data$Year, dataset$Year)

cpi_common_years <- filter(cpi_data, Year %in% common_years)
dinesafe_common_years <- filter(dataset, Year %in% common_years)

cpi_plot <- ggplot(cpi_common_years, aes(x = Year, y = Average_CPI)) +
  geom_line(color = "red") +
  scale_y_continuous(name = "CPI (% Change)", labels = scales::percent) +
  labs() +
  theme_minimal()

dinesafe_plot <- ggplot(dinesafe_common_years, aes(x = Year, y = Total_Infractions)) +
  geom_line(color = "blue") +
  scale_y_continuous(name = "Total Infractions") +
  labs() +
  theme_minimal()

print(cpi_plot)
print(dinesafe_plot)

```
\break
# Discussion and Conclusion
This report examines the state of public food safety in Toronto using two different data sets provided by Toronto City Hall: Dinesafe and Toronto's Dashboard Key Indicators through the statistical programming language R [@citeR] to conduct a comprehensive analysis of Toronto restaurant hygiene pass rates and Infractions. Include packages `AER`[@AER], `future`[@future], `gircreds`[@gitcreds], `knitr`[@knitr], `lintr`[@lintr], `renv`[@renv], `reprex`[@reprex], `styler`[@styler], `tictoc`[@tictoc], `tidyverse`[@tidyverse], `tinytex`[@tinytex], and `usethis`[@usethis]. We focused on an in-depth study of the DineSafe data and concluded that the number of violations showed a clear downward trend within the constraints of the dataset. It is worth noting that the data shows that most enterprises have passed or conditionally passed the assessment of Toronto Public Health. The vast majority of enterprises marked as infractions are at the "Minor" level. They are usually notified of rectification without further punish.

The high compliance rates above may reflect the effectiveness of Toronto Public Health's strategy; however, persistence levels are labelled "Significance" and "Crucial" in the data. Although the number of severe levels of these health conditions is small, relevant administrative departments and even the public must continue to be vigilant about the need and take appropriate measures to contain it.

Beyond this, our comparative analysis of DineSafe and Toronto's Dashboard Key Indicators containing the CPI data set further illuminates the interplay between economic indicators and public health outcomes. A potential economic downturn reflected in the fall in the Consumer Price Index could lead to tighter budgets within food businesses, potentially compromising hygiene standards, according to analysis from a data visualization made in R.

Despite some valid findings, we acknowledge the limitations inherent in this report and the two datasets it used. First, we could not examine these data sets provided by the City of Toronto for potential biases and incomplete content that could distort interpretations of actual trends. Secondly, CPI is a complex indicator that may be affected by various economic activities and policy changes. These factors have not been fully considered in this report. Therefore, future research efforts should use broader data sets and more precise analyses to provide a more convincing picture of public food security in Toronto.
\newpage

# References

